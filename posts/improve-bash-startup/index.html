<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Improve the Bash startup time | Mohammad Banisaeid</title><meta name=keywords content="bash"><meta name=description content="Improve the Bash startup time - Mohammad Banisaeid"><meta name=author content="Mohammad Banisaeid"><link rel=canonical href=https://banisaeid.com/posts/improve-bash-startup/><meta name=google-site-verification content="UxLkc_wDIbzBY2cckNgTqPAOyotK5Cu951VeEgEGXmo"><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://banisaeid.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://banisaeid.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://banisaeid.com/favicon-32x32.png><link rel=apple-touch-icon href=https://banisaeid.com/apple-touch-icon.png><link rel=mask-icon href=https://banisaeid.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Improve the Bash startup time"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://banisaeid.com/posts/improve-bash-startup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-31T17:18:30+01:00"><meta property="article:modified_time" content="2022-10-31T17:18:30+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Improve the Bash startup time"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://banisaeid.com/posts/"},{"@type":"ListItem","position":3,"name":"Improve the Bash startup time","item":"https://banisaeid.com/posts/improve-bash-startup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Improve the Bash startup time","name":"Improve the Bash startup time","description":"","keywords":["bash"],"articleBody":"I do have a relatively big bashrc file. If you look at that file, you will see this line towards the end:\ntest -f ~/.bashrc_local \u0026\u0026 source ~/.bashrc_local I use that ~/.bashrc_local to keep my personal / work configurations separate.\nFor quite some time I was bothered by how long it took for Bash to start on my machines. I never measured the actual startup time, but it made me hesitant to open up new terminal windows.\nSo one day I decided to take care of the slowness.\nIf you search on the Internet, there aren’t that many tools to help with profiling Bash scripts. One trick that I found is to add the following lines around isolated pieces of shell commands and see what they actually do:\nset -v set -x set +v set +x Using this technique, you will get a trace log of what’s going on behind the scenes. With some good old trial-and-error, I found these 2 issues in my case:\nUnnecessary calls to brew to get configuration Eagerly processing all shell completion files Calling brew in your bashrc I love Homebrew. It is an amazing package manager. However, it is written in Ruby and has a quite slow startup time.\nTo give you an idea of how slow it can be, I will use Hyperfine to measure the average time for calling brew --prefix. This brew command gives Homebrew’s install path and you can use it to add your installed packages’ bin directories to $PATH, among other things.\nOn my machine:\n$ hyperfine 'brew --prefix' Benchmark 1: brew --prefix Time (mean ± σ): 36.7 ms ± 1.1 ms [User: 14.5 ms, System: 14.7 ms] Range (min … max): 35.2 ms … 41.2 ms 72 runs That’s 36 ms just to give us the installation path!\nYou might think that 36 ms is not much, but I had several calls to brew --prefix in my bashrc to get bin paths for coreutils, GNU grep, and other tools. These all add up to hundreds of milliseconds each time the bashrc file is sourced by Bash.\nSolution\nFirst, I use brew shellenv to generate environment variables related to Homebrew. One of them is $HOMEBREW_PREFIX which, as you’ve probably guessed, gives us the installation path. Now instead of calling brew --prefix, I can use that environment variable.\nEven better, I call brew shellenv only once and store the result in a file ($HOME/.brew_env). Then in my bashrc I just source that file and save some more precious milliseconds!\nHere is the relevant part in my bashrc:\n_brew_env_file=\"$HOME/.brew_env\" __make_brew_envs_file() { # File already exists. Nothing to do. if [[ -r \"$HOME/.brew_env\" ]]; then return fi echo \"Creating '$_brew_env_file' file for the first time.\" echo \"# Auto-generated by .bashrc script\" \u003e $_brew_env_file echo \u003e\u003e $_brew_env_file if [[ -x \"$(command -v /opt/homebrew/bin/brew)\" ]]; then /opt/homebrew/bin/brew shellenv \u003e\u003e $_brew_env_file elif [[ -x \"$(command -v /usr/local/bin/brew)\" ]]; then /usr/local/bin/brew shellenv \u003e\u003e $_brew_env_file fi } __make_brew_envs_file source $_brew_env_file Eagerly processing all shell completion files Before starting my journey in optimizing my bashrc, I suspected that this was the culprit. I wasn’t wrong. This was the second source of slowness.\nOn macOS, I use Bash Completion package to get shell completion for several commands.\nAfter installing that package, brew tells you to add this line to your Bash startup file:\n[[ -r \"/usr/local/etc/profile.d/bash_completion.sh\" ]] \u0026\u0026 . \"/usr/local/etc/profile.d/bash_completion.sh\" This works fine. The problem is that whenever you install a package with brew, brew adds the relevant completion files to $HOMEBREW_PREFIX/etc/bash_completion.d/ folder. Using the line above, bash-completion package loads all files in the mentioned folder eagerly. This can get very slow if you have installed too many packages.\nWhat we ideally want is to process a completion file on-demand. In other words, when I type tar -- and press Tab, I want the relevant completion file to be processed so Bash can give me the completion options. Fortunately bash-completion package supports this out of the box.\nTo get that, first we need to install the HEAD version of it, because the usual Homebrew version is rather old. To install the HEAD version:\nbrew install --HEAD bash-completion@2 (I am using Bash 5.x, so I need to use the @2 version)\nThen, I disable the eager loading of those Homebrew-installed completion files:\nexport BASH_COMPLETION_COMPAT_DIR=\"/blackhole!\" /blackhole! can be any non-existing path.\nFinally, I ask bash-completion to process Homebrew-installed completion files lazily:\nexport BASH_COMPLETION_USER_DIR=\"$HOMEBREW_PREFIX/etc/bash-completion:$HOME/.local/share/bash-completion\" There are actually two paths specified there. One is for packages that are installed via brew install .... The other is for my own custom completion files that I put in ~/.local/share/bash-completion/.\nThe ability to add several folders to BASH_COMPLETION_USER_DIR is added in recent versions of bash-completion@2. That’s why I used --HEAD when installing it.\nThe full code looks like this:\n__check_bash_completion_symlink() { # Create the symlink mkdir -p \"$HOMEBREW_PREFIX/etc/bash-completion\" ln -sf \"$HOMEBREW_PREFIX/etc/bash_completion.d\" \"$HOMEBREW_PREFIX/etc/bash-completion/completions\" # Directories for lazy-loading export BASH_COMPLETION_USER_DIR=\"$HOMEBREW_PREFIX/etc/bash-completion:$HOME/.local/share/bash-completion\" # Disable the eagerly-loaded completion scripts export BASH_COMPLETION_COMPAT_DIR=\"/blackhole!\" } __check_bash_completion_symlink [[ -r \"$HOMEBREW_PREFIX/etc/profile.d/bash_completion.sh\" ]] \u0026\u0026 . \"$HOMEBREW_PREFIX/etc/profile.d/bash_completion.sh\" On important note: bash-completion expects to find a completions folder inside each folder that’s specified in BASH_COMPLETION_USER_DIR. That’s the reason for the ln -s trick up there.\n","wordCount":"858","inLanguage":"en","datePublished":"2022-10-31T17:18:30+01:00","dateModified":"2022-10-31T17:18:30+01:00","author":{"@type":"Person","name":"Mohammad Banisaeid"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://banisaeid.com/posts/improve-bash-startup/"},"publisher":{"@type":"Organization","name":"Mohammad Banisaeid","logo":{"@type":"ImageObject","url":"https://banisaeid.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://banisaeid.com accesskey=h title="Mohammad Banisaeid (Alt + H)">Mohammad Banisaeid</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://banisaeid.com/archive/ title=Archive><span>Archive</span></a></li><li><a href=https://banisaeid.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.github.com/smbl64 title=GitHub><span>GitHub</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Improve the Bash startup time</h1><div class=post-meta><span title='2022-10-31 17:18:30 +0100 +0100'>October 31, 2022</span>&nbsp;·&nbsp;Mohammad Banisaeid</div></header><div class=post-content><p>I do have a relatively big <a href=https://github.com/smbl64/dotfiles/blob/master/bash/bashrc><code>bashrc</code></a> file. If you look at that file, you will see this line towards the end:</p><pre><code>test -f ~/.bashrc_local &amp;&amp; source ~/.bashrc_local
</code></pre><p>I use that <code>~/.bashrc_local</code> to keep my personal / work configurations separate.</p><p>For quite some time I was bothered by how long it took for Bash to start on my machines. I never measured the actual startup time, but it made me hesitant to open up new terminal windows.</p><p>So one day I decided to take care of the slowness.</p><p>If you search on the Internet, there aren&rsquo;t that many tools to help with profiling Bash scripts. One trick that I found is to add the following lines around isolated pieces of shell commands and see what they actually do:</p><pre><code class=language-bash>set -v
set -x 

&lt;YOUR COMMANDS&gt;

set +v
set +x
</code></pre><p>Using this technique, you will get a trace log of what&rsquo;s going on behind the scenes. With some good old trial-and-error, I found these 2 issues in my case:</p><ol><li>Unnecessary calls to <code>brew</code> to get configuration</li><li>Eagerly processing all shell completion files</li></ol><h2 id=calling-brew-in-your-bashrc>Calling <code>brew</code> in your bashrc<a hidden class=anchor aria-hidden=true href=#calling-brew-in-your-bashrc>#</a></h2><p>I love <a href=https://brew.sh/>Homebrew</a>. It is an amazing package manager. However, it is written in Ruby and has a quite slow startup time.</p><p>To give you an idea of how slow it can be, I will use <a href=https://github.com/sharkdp/hyperfine>Hyperfine</a> to measure the average time for calling <code>brew --prefix</code>. This <code>brew</code> command gives Homebrew&rsquo;s install path and you can use it to add your installed packages&rsquo; <code>bin</code> directories to <code>$PATH</code>, among other things.</p><p>On my machine:</p><pre><code class=language-bash>$ hyperfine 'brew --prefix'
Benchmark 1: brew --prefix
  Time (mean ± σ):      36.7 ms ±   1.1 ms    [User: 14.5 ms, System: 14.7 ms]
  Range (min … max):    35.2 ms …  41.2 ms    72 runs
</code></pre><p>That&rsquo;s <code>36 ms</code> just to give us the installation path!</p><p>You might think that <code>36 ms</code> is not much, but I had several calls to <code>brew --prefix</code> in my <code>bashrc</code> to get <code>bin</code> paths for <code>coreutils</code>, <code>GNU grep</code>, and other tools. These all add up to hundreds of milliseconds each time the <code>bashrc</code> file is sourced by Bash.</p><p><strong>Solution</strong></p><p>First, I use <code>brew shellenv</code> to generate environment variables related to Homebrew. One of them is <code>$HOMEBREW_PREFIX</code> which, as you&rsquo;ve probably guessed, gives us the installation path. Now instead of calling <code>brew --prefix</code>, I can use that environment variable.</p><p>Even better, I call <code>brew shellenv</code> <em>only once</em> and store the result in a file (<code>$HOME/.brew_env</code>). Then in my <code>bashrc</code> I just <code>source</code> that file and save some more precious milliseconds!</p><p>Here is the relevant part in my <a href=https://github.com/smbl64/dotfiles/blob/master/bash/bashrc><code>bashrc</code></a>:</p><pre><code class=language-bash>_brew_env_file=&quot;$HOME/.brew_env&quot;
__make_brew_envs_file() {
    # File already exists. Nothing to do.
    if [[ -r &quot;$HOME/.brew_env&quot; ]]; then
        return
    fi

    echo &quot;Creating '$_brew_env_file' file for the first time.&quot;
    echo &quot;# Auto-generated by .bashrc script&quot; &gt; $_brew_env_file
    echo &gt;&gt; $_brew_env_file

    if [[ -x &quot;$(command -v /opt/homebrew/bin/brew)&quot; ]]; then
        /opt/homebrew/bin/brew shellenv &gt;&gt; $_brew_env_file
    elif [[ -x &quot;$(command -v /usr/local/bin/brew)&quot; ]]; then
        /usr/local/bin/brew shellenv &gt;&gt; $_brew_env_file
    fi
}

__make_brew_envs_file
source $_brew_env_file
</code></pre><h2 id=eagerly-processing-all-shell-completion-files>Eagerly processing all shell completion files<a hidden class=anchor aria-hidden=true href=#eagerly-processing-all-shell-completion-files>#</a></h2><p>Before starting my journey in optimizing my <code>bashrc</code>, I suspected that <em>this</em> was the culprit. I wasn&rsquo;t wrong. This was the second source of slowness.</p><p>On macOS, I use <a href=https://github.com/scop/bash-completion>Bash Completion</a> package to get shell completion for several commands.</p><p>After installing that package, <code>brew</code> tells you to add this line to your Bash startup file:</p><pre><code class=language-bash> [[ -r &quot;/usr/local/etc/profile.d/bash_completion.sh&quot; ]] &amp;&amp; 
    . &quot;/usr/local/etc/profile.d/bash_completion.sh&quot;
</code></pre><p>This works fine. The problem is that whenever you install a package with <code>brew</code>, <code>brew</code> adds the relevant completion files to <code>$HOMEBREW_PREFIX/etc/bash_completion.d/</code> folder. Using the line above, <code>bash-completion</code> package loads all files in the mentioned folder <em>eagerly</em>. This can get <em>very slow</em> if you have installed too many packages.</p><p>What we ideally want is to process a completion file <em>on-demand</em>. In other words, when I type <code>tar --</code> and press Tab, I want the relevant completion file to be processed so Bash can give me the completion options. Fortunately <code>bash-completion</code> package supports this out of the box.</p><p>To get that, first we need to install the <code>HEAD</code> version of it, because the usual Homebrew version is rather old. To install the <code>HEAD</code> version:</p><pre><code>brew install --HEAD bash-completion@2
</code></pre><p>(I am using Bash 5.x, so I need to use the <code>@2</code> version)</p><p>Then, I disable the eager loading of those Homebrew-installed completion files:</p><pre><code>export BASH_COMPLETION_COMPAT_DIR=&quot;/blackhole!&quot;
</code></pre><p><code>/blackhole!</code> can be any non-existing path.</p><p>Finally, I ask <code>bash-completion</code> to process Homebrew-installed completion files lazily:</p><pre><code>export BASH_COMPLETION_USER_DIR=&quot;$HOMEBREW_PREFIX/etc/bash-completion:$HOME/.local/share/bash-completion&quot;
</code></pre><p>There are actually two paths specified there. One is for packages that are installed via <code>brew install ...</code>. The other is for my own custom completion files that I put in <code>~/.local/share/bash-completion/</code>.</p><blockquote><p>The ability to add several folders to <code>BASH_COMPLETION_USER_DIR</code> is added in recent versions of <code>bash-completion@2</code>. That&rsquo;s why I used <code>--HEAD</code> when installing it.</p></blockquote><p>The full code looks like this:</p><pre><code>__check_bash_completion_symlink() {
    # Create the symlink
    mkdir -p &quot;$HOMEBREW_PREFIX/etc/bash-completion&quot;
    ln -sf &quot;$HOMEBREW_PREFIX/etc/bash_completion.d&quot; &quot;$HOMEBREW_PREFIX/etc/bash-completion/completions&quot;

    # Directories for lazy-loading
    export BASH_COMPLETION_USER_DIR=&quot;$HOMEBREW_PREFIX/etc/bash-completion:$HOME/.local/share/bash-completion&quot;

    # Disable the eagerly-loaded completion scripts
    export BASH_COMPLETION_COMPAT_DIR=&quot;/blackhole!&quot;
}

__check_bash_completion_symlink
[[ -r &quot;$HOMEBREW_PREFIX/etc/profile.d/bash_completion.sh&quot; ]] &amp;&amp; 
    . &quot;$HOMEBREW_PREFIX/etc/profile.d/bash_completion.sh&quot;
</code></pre><p>On important note: <code>bash-completion</code> expects to find a <code>completions</code> folder inside each folder that&rsquo;s specified in <code>BASH_COMPLETION_USER_DIR</code>. That&rsquo;s the reason for the <code>ln -s</code> trick up there.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://banisaeid.com/tags/bash/>bash</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://banisaeid.com>Mohammad Banisaeid</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>