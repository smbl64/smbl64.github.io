<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Improve the Bash startup time | Mohammad Banisaeid</title><meta name=keywords content="bash"><meta name=description content="Improve the Bash startup time - Mohammad Banisaeid"><meta name=author content="Mohammad Banisaeid"><link rel=canonical href=https://banisaeid.com/posts/improve-bash-startup/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d13dc9670c54a799901d8f51eb366234127600b84f76504283993a1e6bb2ffd7.css integrity="sha256-0T3JZwxUp5mQHY9R6zZiNBJ2ALhPdlBCg5k6Hmuy/9c=" rel="preload stylesheet" as=style><link rel=icon href=https://banisaeid.com/favicon.ico><link rel=apple-touch-icon href=https://banisaeid.com/apple-touch-icon.png><meta name=twitter:title content="Improve the Bash startup time | Mohammad Banisaeid"><meta name=twitter:description content><meta property="og:title" content="Improve the Bash startup time | Mohammad Banisaeid"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://banisaeid.com/posts/improve-bash-startup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-31T17:18:30+01:00"><meta property="article:modified_time" content="2022-10-31T17:18:30+01:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://banisaeid.com/posts/"},{"@type":"ListItem","position":3,"name":"Improve the Bash startup time","item":"https://banisaeid.com/posts/improve-bash-startup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Improve the Bash startup time | Mohammad Banisaeid","name":"Improve the Bash startup time","description":"","keywords":["bash"],"wordCount":"858","inLanguage":"en","datePublished":"2022-10-31T17:18:30+01:00","dateModified":"2022-10-31T17:18:30+01:00","author":{"@type":"Person","name":"Mohammad Banisaeid"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://banisaeid.com/posts/improve-bash-startup/"},"publisher":{"@type":"Organization","name":"Mohammad Banisaeid","logo":{"@type":"ImageObject","url":"https://banisaeid.com/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://banisaeid.com accesskey=h title="Mohammad Banisaeid (Alt + H)">Mohammad Banisaeid</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://banisaeid.com/archive/ title=Archive>Archive</a></li><li><a href=https://banisaeid.com/tags/ title=Tags>Tags</a></li><li><a href=https://www.github.com/smbl64/ title=GitHub>GitHub</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Improve the Bash startup time</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>October 31, 2022</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://banisaeid.com/tags/bash/>bash</a></span></span></div></header><div class=post-content><p>I do have a relatively big <a href=https://github.com/smbl64/dotfiles/blob/master/bash/bashrc><code>bashrc</code></a> file. If you look at that file, you will see this line towards the end:</p><pre tabindex=0><code>test -f ~/.bashrc_local &amp;&amp; source ~/.bashrc_local
</code></pre><p>I use that <code>~/.bashrc_local</code> to keep my personal / work configurations separate.</p><p>For quite some time I was bothered by how long it took for Bash to start on my machines. I never measured the actual startup time, but it made me hesitant to open up new terminal windows.</p><p>So one day I decided to take care of the slowness.</p><p>If you search on the Internet, there aren&rsquo;t that many tools to help with profiling Bash scripts. One trick that I found is to add the following lines around isolated pieces of shell commands and see what they actually do:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>set</span> -v
</span></span><span class=line><span class=cl><span class=nb>set</span> -x 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;YOUR COMMANDS&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> +v
</span></span><span class=line><span class=cl><span class=nb>set</span> +x
</span></span></code></pre></div><p>Using this technique, you will get a trace log of what&rsquo;s going on behind the scenes. With some good old trial-and-error, I found these 2 issues in my case:</p><ol><li>Unnecessary calls to <code>brew</code> to get configuration</li><li>Eagerly processing all shell completion files</li></ol><h2 id=calling-brew-in-your-bashrc>Calling <code>brew</code> in your bashrc<a hidden class=anchor aria-hidden=true href=#calling-brew-in-your-bashrc>¶</a></h2><p>I love <a href=https://brew.sh/>Homebrew</a>. It is an amazing package manager. However, it is written in Ruby and has a quite slow startup time.</p><p>To give you an idea of how slow it can be, I will use <a href=https://github.com/sharkdp/hyperfine>Hyperfine</a> to measure the average time for calling <code>brew --prefix</code>. This <code>brew</code> command gives Homebrew&rsquo;s install path and you can use it to add your installed packages&rsquo; <code>bin</code> directories to <code>$PATH</code>, among other things.</p><p>On my machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ hyperfine <span class=s1>&#39;brew --prefix&#39;</span>
</span></span><span class=line><span class=cl>Benchmark 1: brew --prefix
</span></span><span class=line><span class=cl>  Time <span class=o>(</span>mean ± σ<span class=o>)</span>:      36.7 ms ±   1.1 ms    <span class=o>[</span>User: 14.5 ms, System: 14.7 ms<span class=o>]</span>
</span></span><span class=line><span class=cl>  Range <span class=o>(</span>min … max<span class=o>)</span>:    35.2 ms …  41.2 ms    <span class=m>72</span> runs
</span></span></code></pre></div><p>That&rsquo;s <code>36 ms</code> just to give us the installation path!</p><p>You might think that <code>36 ms</code> is not much, but I had several calls to <code>brew --prefix</code> in my <code>bashrc</code> to get <code>bin</code> paths for <code>coreutils</code>, <code>GNU grep</code>, and other tools. These all add up to hundreds of milliseconds each time the <code>bashrc</code> file is sourced by Bash.</p><p><strong>Solution</strong></p><p>First, I use <code>brew shellenv</code> to generate environment variables related to Homebrew. One of them is <code>$HOMEBREW_PREFIX</code> which, as you&rsquo;ve probably guessed, gives us the installation path. Now instead of calling <code>brew --prefix</code>, I can use that environment variable.</p><p>Even better, I call <code>brew shellenv</code> <em>only once</em> and store the result in a file (<code>$HOME/.brew_env</code>). Then in my <code>bashrc</code> I just <code>source</code> that file and save some more precious milliseconds!</p><p>Here is the relevant part in my <a href=https://github.com/smbl64/dotfiles/blob/master/bash/bashrc><code>bashrc</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>_brew_env_file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.brew_env&#34;</span>
</span></span><span class=line><span class=cl>__make_brew_envs_file<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># File already exists. Nothing to do.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> -r <span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.brew_env&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Creating &#39;</span><span class=nv>$_brew_env_file</span><span class=s2>&#39; file for the first time.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;# Auto-generated by .bashrc script&#34;</span> &gt; <span class=nv>$_brew_env_file</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> &gt;&gt; <span class=nv>$_brew_env_file</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> -x <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>command</span> -v /opt/homebrew/bin/brew<span class=k>)</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        /opt/homebrew/bin/brew shellenv &gt;&gt; <span class=nv>$_brew_env_file</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=o>[[</span> -x <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>command</span> -v /usr/local/bin/brew<span class=k>)</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        /usr/local/bin/brew shellenv &gt;&gt; <span class=nv>$_brew_env_file</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>__make_brew_envs_file
</span></span><span class=line><span class=cl><span class=nb>source</span> <span class=nv>$_brew_env_file</span>
</span></span></code></pre></div><h2 id=eagerly-processing-all-shell-completion-files>Eagerly processing all shell completion files<a hidden class=anchor aria-hidden=true href=#eagerly-processing-all-shell-completion-files>¶</a></h2><p>Before starting my journey in optimizing my <code>bashrc</code>, I suspected that <em>this</em> was the culprit. I wasn&rsquo;t wrong. This was the second source of slowness.</p><p>On macOS, I use <a href=https://github.com/scop/bash-completion>Bash Completion</a> package to get shell completion for several commands.</p><p>After installing that package, <code>brew</code> tells you to add this line to your Bash startup file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> <span class=o>[[</span> -r <span class=s2>&#34;/usr/local/etc/profile.d/bash_completion.sh&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>    . <span class=s2>&#34;/usr/local/etc/profile.d/bash_completion.sh&#34;</span>
</span></span></code></pre></div><p>This works fine. The problem is that whenever you install a package with <code>brew</code>, <code>brew</code> adds the relevant completion files to <code>$HOMEBREW_PREFIX/etc/bash_completion.d/</code> folder. Using the line above, <code>bash-completion</code> package loads all files in the mentioned folder <em>eagerly</em>. This can get <em>very slow</em> if you have installed too many packages.</p><p>What we ideally want is to process a completion file <em>on-demand</em>. In other words, when I type <code>tar --</code> and press Tab, I want the relevant completion file to be processed so Bash can give me the completion options. Fortunately <code>bash-completion</code> package supports this out of the box.</p><p>To get that, first we need to install the <code>HEAD</code> version of it, because the usual Homebrew version is rather old. To install the <code>HEAD</code> version:</p><pre tabindex=0><code>brew install --HEAD bash-completion@2
</code></pre><p>(I am using Bash 5.x, so I need to use the <code>@2</code> version)</p><p>Then, I disable the eager loading of those Homebrew-installed completion files:</p><pre tabindex=0><code>export BASH_COMPLETION_COMPAT_DIR=&#34;/blackhole!&#34;
</code></pre><p><code>/blackhole!</code> can be any non-existing path.</p><p>Finally, I ask <code>bash-completion</code> to process Homebrew-installed completion files lazily:</p><pre tabindex=0><code>export BASH_COMPLETION_USER_DIR=&#34;$HOMEBREW_PREFIX/etc/bash-completion:$HOME/.local/share/bash-completion&#34;
</code></pre><p>There are actually two paths specified there. One is for packages that are installed via <code>brew install ...</code>. The other is for my own custom completion files that I put in <code>~/.local/share/bash-completion/</code>.</p><blockquote><p>The ability to add several folders to <code>BASH_COMPLETION_USER_DIR</code> is added in recent versions of <code>bash-completion@2</code>. That&rsquo;s why I used <code>--HEAD</code> when installing it.</p></blockquote><p>The full code looks like this:</p><pre tabindex=0><code>__check_bash_completion_symlink() {
    # Create the symlink
    mkdir -p &#34;$HOMEBREW_PREFIX/etc/bash-completion&#34;
    ln -sf &#34;$HOMEBREW_PREFIX/etc/bash_completion.d&#34; &#34;$HOMEBREW_PREFIX/etc/bash-completion/completions&#34;

    # Directories for lazy-loading
    export BASH_COMPLETION_USER_DIR=&#34;$HOMEBREW_PREFIX/etc/bash-completion:$HOME/.local/share/bash-completion&#34;

    # Disable the eagerly-loaded completion scripts
    export BASH_COMPLETION_COMPAT_DIR=&#34;/blackhole!&#34;
}

__check_bash_completion_symlink
[[ -r &#34;$HOMEBREW_PREFIX/etc/profile.d/bash_completion.sh&#34; ]] &amp;&amp; 
    . &#34;$HOMEBREW_PREFIX/etc/profile.d/bash_completion.sh&#34;
</code></pre><p>On important note: <code>bash-completion</code> expects to find a <code>completions</code> folder inside each folder that&rsquo;s specified in <code>BASH_COMPLETION_USER_DIR</code>. That&rsquo;s the reason for the <code>ln -s</code> trick up there.</p></div><footer class=post-footer></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://banisaeid.com>Mohammad Banisaeid</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a></span>
<span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>